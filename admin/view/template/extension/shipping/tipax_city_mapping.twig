{{ header }}{{ column_left }}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <a href="{{ cancel_url }}" class="btn btn-default"><i class="fa fa-reply"></i> لغو</a>
        <button id="auto-match" class="btn btn-success"><i class="fa fa-magic"></i> تطابق خودکار</button>
        <button id="bulk-add-cities" class="btn btn-info"><i class="fa fa-plus-circle"></i> افزودن گروهی شهرها</button>
      </div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        <li><a href="{{ this.url.link('common/dashboard', 'user_token=' ~ user_token, true) }}">داشبورد</a></li>
        <li><a href="{{ this.url.link('extension/shipping/tipax', 'user_token=' ~ user_token, true) }}">تیپاکس</a></li>
      </ul>
    </div>
  </div>

  <div class="container-fluid">
    {% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button></div>
    {% endif %}
    {% if success %}
    <div class="alert alert-success alert-dismissible"><i class="fa fa-check"></i> {{ success }} <button type="button"
        class="close" data-dismiss="alert">&times;</button></div>
    {% endif %}

    <div class="panel panel-default">
      <div class="panel-heading"><i class="fa fa-map-marker"></i> تطابق شهرهای تیپاکس با اپن‌کارت</div>
      <div class="panel-body">

        <div class="row" style="margin-bottom:10px">
          <div class="col-sm-6">
            <ul class="nav nav-pills">
              <li{% if filter=='unmatched' %} class="active" {% endif %}>
                <a href="{{ filter_urls.unmatched }}">نامطابق ({{ counts.unmatched }})</a>
                </li>
                <li{% if filter=='matched' %} class="active" {% endif %}>
                  <a href="{{ filter_urls.matched }}">تطابق‌داده‌شده ({{ counts.matched }})</a>
                  </li>
                  <li{% if filter=='all' %} class="active" {% endif %}>
                    <a href="{{ filter_urls.all }}">همه ({{ counts.all }})</a>
                    </li>
            </ul>
          </div>
          <div class="col-sm-6">
            <form class="form-inline pull-left" method="get" action="{{ search_action }}">
              <input type="hidden" name="route" value="extension/shipping/tipax" />
              <input type="hidden" name="action" value="city_mapping" />
              <input type="hidden" name="user_token" value="{{ user_token }}" />
              <input type="hidden" name="filter" value="{{ filter }}" />
              <input type="hidden" name="limit" value="{{ limit }}" />
              <div class="input-group">
                <input type="text" class="form-control" name="q" placeholder="{{ text_mapping_search }}"
                  value="{{ q }}" />
                <span class="input-group-btn">
                  <button class="btn btn-default" type="submit"><i class="fa fa-search"></i></button>
                </span>
              </div>
            </form>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="map-table">
            <thead>
              <tr>
                <th style="width:60px">#</th>
                <th>شهر تیپاکس</th>
                <th>استان تیپاکس</th>
                <th>شهر اپن‌کارت</th>
                <th style="width:120px">ذخیره</th>
              </tr>
            </thead>
            <tbody>
              {% for row in rows %}
              <tr>
                <td>{{ loop.index + ((page-1) * limit) }}</td>
                <td>{{ row.city_title }}</td>
                <td>{{ row.state_title }}</td>
                <td>
                  <select class="form-control oc-city-select" data-tp="{{ row.tipax_city_id }}" style="width:100%">
                    <option value="">انتخاب کنید...</option>
                    {% for oc in oc_cities %}
                    <option value="{{ oc.city_id }}" {% if oc.city_id==row.city_id %} selected{% endif %}>{{ oc.name }}
                    </option>
                    {% endfor %}
                  </select>
                  {% if row.oc_city_name %}
                  <div class="help-block">فعلی: {{ row.oc_city_name }}</div>
                  {% endif %}
                </td>
                <td>
                  <button class="btn btn-primary btn-sm save-map" data-tp="{{ row.tipax_city_id }}">{{ button_map_save
                    }}</button>
                  {% if filter == 'unmatched' %}
                  <button class="btn btn-success btn-sm add-to-oc" data-tp="{{ row.tipax_city_id }}"
                    data-city="{{ row.city_title }}" data-state="{{ row.state_title }}" style="margin-top: 5px;">
                    <i class="fa fa-plus"></i> افزودن به اپن‌کارت
                  </button>
                  {% endif %}
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" class="text-center">موردی یافت نشد</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="row">
          <div class="col-sm-6 text-left">{{ pagination|raw }}</div>
          <div class="col-sm-6 text-right">{{ results }}</div>
        </div>

      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  (function ($) {
    var SAVE_MAPPING_URL = '{{ save_mapping_url|raw }}';
    var AUTO_MATCH_URL = '{{ auto_match_url|raw }}';

    function initSelects() {
      $('.oc-city-select').select2({ dir: 'rtl', width: 'resolve', placeholder: 'انتخاب کنید...' });
    }
    initSelects();

    $('.save-map').on('click', function () {
      var tp = $(this).data('tp');
      var oc = $(this).closest('tr').find('.oc-city-select').val();
      if (!oc) { alert('شهر اپن‌کارت را انتخاب کنید'); return; }
      $.ajax({
        url: SAVE_MAPPING_URL,
        method: 'POST',
        dataType: 'json',
        data: { oc_city_id: oc, tipax_city_id: tp }
      }).done(function (j) {
        alert((j.success ? '✓ ' : '✗ ') + (j.message || ''));
      }).fail(function (xhr) {
        var msg = 'خطا در ذخیره';
        if (xhr.responseJSON && xhr.responseJSON.message) msg = xhr.responseJSON.message;
        alert('✗ ' + msg);
      });
    });

    $('#auto-match').on('click', function () {
      var b = $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> تطابق...');
      $.getJSON(AUTO_MATCH_URL).done(function (j) {
        if (j.success) {
          alert('تطابق خودکار انجام شد: ' + (j.matched || 0) + ' از ' + (j.total || 0));
          location.reload();
        } else {
          alert('✗ ' + (j.message || 'ناموفق'));
        }
      }).fail(function (xhr) {
        var msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'خطای ارتباط';
        alert('✗ ' + msg);
      }).always(function () { b.prop('disabled', false).html('<i class="fa fa-magic"></i> تطابق خودکار'); });
    });


    $('.add-to-oc').on('click', function () {
      var btn = $(this);
      var tipaxCityId = btn.data('tp');
      var cityName = btn.data('city');
      var stateName = btn.data('state');

      if (!confirm('شهر "' + cityName + '" به جدول شهرهای اپن‌کارت اضافه شود؟')) return;

      btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> در حال افزودن...');

      $.ajax({
        url: '{{ add_city_url|raw }}',
        method: 'POST',
        dataType: 'json',
        data: {
          tipax_city_id: tipaxCityId,
          city_name: cityName,
          state_name: stateName
        }
      }).done(function (j) {
        alert((j.success ? '✓ ' : '✗ ') + (j.message || ''));
        if (j.success) {
          location.reload();
        }
      }).fail(function (xhr, ajaxOptions, thrownError) {
        var msg = (xhr.responseJSON && xhr.responseJSON.message) ? xhr.responseJSON.message : 'خطای ارتباط';
        alert('✗ ' + msg);
        console.error(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }).always(function () {
        btn.prop('disabled', false).html('<i class="fa fa-plus"></i> افزودن به اپن‌کارت');
      });
    });

    $('#bulk-add-cities').on('click', function () {
      if (!confirm('همه شهرهای نامطابق به جدول شهرهای اپن‌کارت اضافه شوند؟\n\nاین عملیات ممکن است چند دقیقه طول بکشد.')) return;

      var btn = $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> در حال افزودن...');

      $.ajax({
        url: '{{ bulk_add_cities_url|raw }}',
        method: 'POST',
        dataType: 'json',
        timeout: 300000 // 5 minutes timeout
      }).done(function (j) {
        console.log('Bulk Add Response:', j);

        var message = (j.success ? '✓ ' : '✗ ') + (j.message || 'پاسخ نامعلوم');

        if (j.details) {
          message += '\n\nجزئیات:\n';
          message += 'موفق: ' + (j.details.success_count || 0) + '\n';
          message += 'ناموفق: ' + (j.details.failed_count || 0) + '\n';
          message += 'کل: ' + (j.details.total_count || 0);

          if (j.details.failed_cities && j.details.failed_cities.length > 0) {
            message += '\n\nشهرهای ناموفق (نمونه):';
            j.details.failed_cities.slice(0, 5).forEach(function (city) {
              message += '\n- ' + city.name + ': ' + city.error;
            });
            if (j.details.failed_cities.length > 5) {
              message += '\n... و ' + (j.details.failed_cities.length - 5) + ' شهر دیگر';
            }
          }
        }

        alert(message);

        if (j.success) {
          location.reload();
        }
      }).fail(function (xhr, status, error) {
        console.error('Bulk Add Error:', xhr, status, error);
        console.error('Response Text:', xhr.responseText);

        var msg = 'خطای ارتباط';
        if (xhr.responseJSON && xhr.responseJSON.message) {
          msg = xhr.responseJSON.message;
        } else if (xhr.responseText) {
          msg = 'خطا: ' + xhr.responseText.substring(0, 200);
        } else {
          msg = 'خطا: ' + status + ' - ' + error;
        }

        alert('✗ ' + msg);
      }).always(function () {
        btn.prop('disabled', false).html('<i class="fa fa-plus-circle"></i> افزودن گروهی شهرها');
      });
    });

  })(jQuery);

</script>
{{ footer }}